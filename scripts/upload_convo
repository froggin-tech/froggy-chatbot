import csv
import json
import os
import pandas as pd
from dotenv import load_dotenv
from google.oauth2 import service_account
from googleapiclient.discovery import build

load_dotenv()

creds_path = os.environ.get('G_CREDENTIALS')
csv_name = os.environ.get('G_FILE_NAME', None)
csv_path = "../data/convos/"+csv_name+".csv"
ssheet_folder = os.environ.get('G_FOLDER_ID', None)
ssheet_id = os.environ.get('G_SPREADSHEET_ID', None)

print(f"Trying to load CSV from: {csv_path}")
df = pd.read_csv(csv_path)
values = [df.columns.tolist()] + df.values.tolist()

# authenticate with the service account
scopes = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
creds = service_account.Credentials.from_service_account_file(creds_path, scopes=scopes)

# makes the connection to athe sheets API service
sheets_service = build('sheets', 'v4', credentials=creds)
drive_service = build('drive', 'v3', credentials=creds)

drive_about = drive_service.about().get(fields="storageQuota").execute()
print(json.dumps(drive_about, indent=2))

# Create a new spreadsheet for the user if it doesn't already exist
if ssheet_id == '':
  file_metadata = {
      'name': csv_name,
      'mimeType': 'application/vnd.google-apps.spreadsheet',
      'parents': [ssheet_folder]
  }
  file = drive_service.files().create(
      body=file_metadata,
      fields='id'
  ).execute()
  ssheet_id = file.get('id')

  convo_body = {
    "requests":[{
        "updateSheetProperties": {
          "properties": {
          "sheetId": 0,
          "title": "Conversacion"
        },
        "fields": "title"
      }
    }]
  }
  sheets_service.spreadsheets().batchUpdate(spreadsheetId=ssheet_id, body=convo_body).execute()
  
body = {
  'values': values
}

result = sheets_service.spreadsheets().values().update(
  spreadsheetId=ssheet_id,
  range="Conversacion!A1:Z1000",
  valueInputOption="RAW",
  body=body
  ).execute()

print(f"{result.get('updatedCells')} cells updated.")